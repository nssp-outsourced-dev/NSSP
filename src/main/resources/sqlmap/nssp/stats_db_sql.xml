<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'>
<sqlMap namespace="stats">

	<select id="selectCaseManageList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT
		X.RN,
		X.TOT_CNT,
		X.RC_NO,
		X.ITIV_NO,
		X.CASE_NO,
		X.RC_SE_CD,
		X.INV_PROVIS_NM,
		X.PROGRS_STTUS_NM,
	    X.CHARGER_NM,
	    X.CHARGER_DEPT_NM,
		X.VIOLT_NM,
		X.SUSPCT_NM,
		X.SUFRER_NM,
		X.PRSCT_DE,
		X.TRN_DE
		FROM
		(
			SELECT A.*,
				COUNT(*) OVER() AS TOT_CNT,
				<isNotEmpty property="dataField">
					<isNotEmpty property="sortType">
						ROW_NUMBER() OVER(ORDER BY A.$dataField$ $sortType$ NULLS LAST) RN
					</isNotEmpty>
				</isNotEmpty>
				<isEmpty property="dataField">		
					ROW_NUMBER() OVER(ORDER BY A.RC_NO) RN
				</isEmpty>				
			FROM
			(
				SELECT
				RT.RC_NO,
				RT.ITIV_NO,
				RT.CASE_NO,
				RT.RC_SE_CD,
				RT.PROGRS_STTUS_CD,
				RT.PRSCT_DE,
				RT.INV_PROVIS_CD,
				FN_CD_NM(RT.INV_PROVIS_CD) AS INV_PROVIS_NM,
				FN_CD_NM(RT.PROGRS_STTUS_CD) AS PROGRS_STTUS_NM,
				FN_USER_NM(RT.CHARGER_ID) AS CHARGER_NM,
				FN_DEPT_NM(RT.CHARGER_DEPT_CD) AS CHARGER_DEPT_NM,
				FN_RC_VIOLT_UPPER_NMS(RT.RC_NO) AS VIOLT_NM,
				FN_RC_TRGTER_NM(RT.RC_NO,'00697') AS SUSPCT_NM,
				FN_RC_TRGTER_NM(RT.RC_NO,'00698') AS SUFRER_NM,
				NVL((SELECT MAX(TC.TRN_DE) FROM TRN_CASE TC WHERE TC.RC_NO = RT.RC_NO AND TC.USE_YN = 'Y'),'') AS TRN_DE
				FROM RC_TMPR RT
				WHERE RT.USE_YN = 'Y'
				<isNotEmpty property="searchTrgterNm" >
					AND RT.RC_NO IN (
						SELECT TT.RC_NO
						FROM RC_TMPR_TRGTER TT
						WHERE TT.TRGTER_NM = #searchTrgterNm#
						<isNotEmpty property="searchTrgterCl" prepend="AND">
							TT.TRGTER_SE_CD = #searchTrgterCl#
						</isNotEmpty>
					)
				</isNotEmpty>
				<isNotEmpty property="searchChager" >
					AND RT.CHARGER_ID = #searchChager#
				</isNotEmpty>
				<isNotEmpty property="searchDeptCd" >
					AND RT.CHARGER_DEPT_CD IN (
						SELECT DC.DEPT_CD
						FROM CMN_DEPT_CD DC
						WHERE DC.USE_YN = 'Y' AND DC.DEPT_CD != '00000'
						START WITH DC.DEPT_CD = #searchDeptCd#
						CONNECT BY PRIOR DC.DEPT_CD = DC.DEPT_UPPER_CD
					)
				</isNotEmpty>
				<isNotEmpty property="searchRcNoStart" >
					AND RT.RC_NO <![CDATA[ >= ]]> #searchRcNoStart#
				</isNotEmpty>
				<isNotEmpty property="searchRcNoEnd" >
					AND RT.RC_NO <![CDATA[ <= ]]> #searchRcNoEnd#
				</isNotEmpty>
				<isNotEmpty property="searchCaseNoStart" >
					AND RT.CASE_NO <![CDATA[ >= ]]> #searchCaseNoStart#
				</isNotEmpty>
				<isNotEmpty property="searchCaseNoEnd" >
					AND RT.CASE_NO <![CDATA[ <= ]]> #searchCaseNoEnd#
				</isNotEmpty>

				<isNotEmpty property="searchPrsctDeStart" >
					AND RT.PRSCT_DE <![CDATA[ >= ]]> REPLACE(#searchPrsctDeStart#,'-','')
				</isNotEmpty>
				<isNotEmpty property="searchPrsctDeEnd" >
					AND RT.PRSCT_DE <![CDATA[ <= ]]> REPLACE(#searchPrsctDeEnd#,'-','')
				</isNotEmpty>
			) A
		) X
		<isNotEmpty property="startRow" >
			WHERE (RN <![CDATA[ > ]]> #startRow# AND RN <![CDATA[ <= ]]> #endRow#)
		</isNotEmpty>
		ORDER BY RN ASC
	</select>


	<select id="selectCrimeCaseList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT X.RN
			 , X.TOT_CNT
			 , X.RC_NO
			 , X.ITIV_NO
			 , X.CASE_NO
			 , X.RC_DT
			 , X.OCCRRNC_BEGIN_DT
			 , X.OCCRRNC_END_DT
			 , X.OCCRRNC_ADDR
			 , X.INV_PROVIS_NM
			 , X.PROGRS_STTUS_NM
			 , X.CHARGER_NM
			 , X.CHARGER_DEPT_NM
			 , X.VIOLT_NM
			 , X.SUFRER_NM
			 , X.PRSCT_DE		
			 , X.TRGTER_NM
			 , X.TRGTER_ENG_NM
			 , X.TRGTER_RRN
			 , X.TRGTER_SN
			 , X.SEXDSTN_CD
			 , X.OCCP_NM
			 , X.TRGTER_CPRN
			 , X.TRGTER_CRN
			 , X.DWLSIT_ADDR
		     , X.ATTRACT_PLACE
		     , X.RSL_DT
		     , X.CCDRC_NO
		     , X.TRN_OPINION_NM
		     , X.TRN_VIOLT_NM
		     , X.TRN_NO
		     , X.TRN_DE
             , X.PRSEC_DSPS_DE      --검사처분일
		     , X.PRSEC_DSPS_OUTLINE --검사처분 요지
		     , X.JUDMN_DE           --판결처분일
		     , X.JUDMN_OUTLINE      --판결요지 
		     , X.RM                 --비고
		FROM
		(
			SELECT A.*,
			COUNT(*) OVER() AS TOT_CNT,
			<isNotEmpty property="dataField">
				<isNotEmpty property="sortType">
					ROW_NUMBER() OVER(ORDER BY A.$dataField$ $sortType$ NULLS LAST) RN
				</isNotEmpty>
			</isNotEmpty>
			<isEmpty property="dataField">		
				DENSE_RANK() OVER(PARTITION BY A.CASE_NO ORDER BY A.CASE_NO) RN
			</isEmpty>			
			FROM
			(
				SELECT
				RT.RC_NO,
				RT.ITIV_NO,
				RT.CASE_NO,
				RT.RC_SE_CD,
				RT.INV_PROVIS_CD,
				RT.PROGRS_STTUS_CD,
				RT.OCCRRNC_ZIP,
				RT.OCCRRNC_ADDR,
			    RT.CHARGER_ID,
			    RT.CHARGER_DEPT_CD,
				RT.PRSCT_DE,
                RTT.TRGTER_SN,
                RTT.TRGTER_CL_CD,
                RTT.TRGTER_NM,
                RTT.TRGTER_ENG_NM,
                RTT.SEXDSTN_CD,
                DGUARD.DECRYPT('TBL','ENC',RTT.TRGTER_RRN) AS TRGTER_RRN,
                RTT.OCCP_CD,
                RTT.TRGTER_CPRN,
                RTT.TRGTER_CRN,
                RTT.DWLSIT_ZIP,
                RTT.DWLSIT_ADDR,                
                TO_CHAR(RT.RC_DT, 'YYYY. MM. DD. HH24:MI') AS RC_DT,
				TO_CHAR(RT.OCCRRNC_BEGIN_DT, 'YYYY. MM. DD. HH24:MI') AS OCCRRNC_BEGIN_DT,
				TO_CHAR(RT.OCCRRNC_END_DT, 'YYYY. MM. DD. HH24:MI') AS OCCRRNC_END_DT,
                FN_CD_NM(RT.INV_PROVIS_CD) AS INV_PROVIS_NM,
				FN_CD_NM(RT.PROGRS_STTUS_CD) AS PROGRS_STTUS_NM,
				FN_USER_NM(RT.CHARGER_ID) AS CHARGER_NM,
				FN_DEPT_NM(RT.CHARGER_DEPT_CD) AS CHARGER_DEPT_NM,
				FN_RC_VIOLT_UPPER_NMS(RT.RC_NO) AS VIOLT_NM,
				FN_RC_TRGTER_NM(RT.RC_NO,'00698') AS SUFRER_NM,				
				FN_CD_NM(RTT.OCCP_CD) AS OCCP_NM,
				(
					SELECT LISTAGG(IPA.ATTRACT_PLACE,',') WITHIN GROUP (ORDER BY IPA.RC_NO, IPA.TRGTER_SN)
					FROM INV_PRSCT_ARRST IPA
					WHERE IPA.RC_NO = RTT.RC_NO AND IPA.TRGTER_SN = RTT.TRGTER_SN AND IPA.USE_YN = 'Y'
				) AS ATTRACT_PLACE,
				(
					SELECT LISTAGG(IPA.RSL_DT||'('|| FN_CD_NM(IPA.RSL_RESN_CD) ||')',',') WITHIN GROUP (ORDER BY IPA.RC_NO, IPA.TRGTER_SN)
					FROM INV_PRSCT_ARRST IPA
					WHERE IPA.RC_NO = RTT.RC_NO AND IPA.TRGTER_SN = RTT.TRGTER_SN AND IPA.USE_YN = 'Y' AND IPA.RSL_DT IS NOT NULL
				) AS RSL_DT,
				(
					SELECT REGEXP_REPLACE(LISTAGG(ICI.CCDRC_NO,',') WITHIN GROUP (ORDER BY ICI.CCDRC_NO),'([^,]+)(,\1)+', '\1')
					FROM INV_CCDRC_TRGTER ICI
					WHERE ICI.RC_NO = RTT.RC_NO AND ICI.TRGTER_SN = RTT.TRGTER_SN
				) AS CCDRC_NO,
				(
					SELECT LISTAGG(FN_CD_NM(TV.TRN_OPINION_CD),',') WITHIN GROUP (ORDER BY TV.TRN_NO)
					FROM TRN_VIOLT TV
					WHERE TV.RC_NO = RTT.RC_NO AND TV.TRGTER_SN = RTT.TRGTER_SN
				) AS TRN_OPINION_NM,
				(
					SELECT REGEXP_REPLACE(LISTAGG(FN_VIOLT_NM(TV.VIOLT_CD),',') WITHIN GROUP (ORDER BY TV.VIOLT_CD),'([^,]+)(,\1)+', '\1')
					FROM TRN_VIOLT TV
					WHERE TV.RC_NO = RTT.RC_NO AND TV.TRGTER_SN = RTT.TRGTER_SN
				) AS TRN_VIOLT_NM,
				TC.TRN_NO,
				TC.TRN_DE
			  , TS.PRSEC_DSPS_DE      --검사처분일
			  , TS.PRSEC_DSPS_OUTLINE --검사처분 요지
			  , TS.JUDMN_DE           --판결처분일
			  , TS.JUDMN_OUTLINE      --판결요지 
			  , TS.RM                 --비고
				/*NVL((SELECT MAX(TC.TRN_DE) FROM TRN_CASE TC WHERE TC.RC_NO = RT.RC_NO AND TC.USE_YN = 'Y'),'') AS TRN_DE,*/            
				FROM RC_TMPR RT
				INNER JOIN RC_TMPR_TRGTER RTT ON RT.RC_NO = RTT.RC_NO AND RTT.USE_YN = 'Y' AND RTT.TRGTER_SE_CD = '00697'
				LEFT OUTER JOIN TRN_SUSPCT TS ON TS.RC_NO = RTT.RC_NO AND TS.TRGTER_SN = RTT.TRGTER_SN AND TS.USE_YN = 'Y'
				LEFT OUTER JOIN TRN_CASE TC ON TC.TRN_NO = TS.TRN_NO AND TC.USE_YN = 'Y'
				WHERE RT.USE_YN = 'Y'
				AND RT.CASE_NO IS NOT NULL
				<isNotEmpty property="searchTrgterNm" >
					AND RTT.TRGTER_NM = #searchTrgterNm#
				</isNotEmpty>
				<isNotEmpty property="searchChager" >
					AND RT.CHARGER_ID = #searchChager#
				</isNotEmpty>
				<isNotEmpty property="searchDeptCd" >
					AND RT.CHARGER_DEPT_CD IN (
						SELECT DC.DEPT_CD
						FROM CMN_DEPT_CD DC
						WHERE DC.USE_YN = 'Y' AND DC.DEPT_CD != '00000'
						START WITH DC.DEPT_CD = #searchDeptCd#
						CONNECT BY PRIOR DC.DEPT_CD = DC.DEPT_UPPER_CD
					)
				</isNotEmpty>
				<isNotEmpty property="searchCaseNoStart" >
					AND RT.CASE_NO <![CDATA[ >= ]]> #searchCaseNoStart#
				</isNotEmpty>
				<isNotEmpty property="searchCaseNoEnd" >
					AND RT.CASE_NO <![CDATA[ <= ]]> #searchCaseNoEnd#
				</isNotEmpty>

				<isNotEmpty property="searchPrsctDeStart" >
					AND RT.PRSCT_DE <![CDATA[ >= ]]> REPLACE(#searchPrsctDeStart#,'-','')
				</isNotEmpty>
				<isNotEmpty property="searchPrsctDeEnd" >
					AND RT.PRSCT_DE <![CDATA[ <= ]]> REPLACE(#searchPrsctDeEnd#,'-','')
				</isNotEmpty>
			) A
		) X		
		<isNotEmpty property="startRow" >
			WHERE (RN <![CDATA[ > ]]> #startRow# AND RN <![CDATA[ <= ]]> #endRow#)
		</isNotEmpty>
		ORDER BY CASE_NO ASC
	</select>


	<select id="selectItivCaseList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT
				X.RN,
				X.TOT_CNT,
				X.RC_NO,
				X.ITIV_NO,
				X.CASE_NO,
				X.RC_DT,
				X.ITIV_DT,
				X.OUTSET_RESN,
				X.ITIV_RESULT_NM,
				X.ITIV_CN,
				X.RESULT_DT,
			    X.CHARGER_NM,
			    X.CHARGER_DEPT_NM,
		        X.TRGTER_NM,
		        X.TRGTER_RRN,
		        X.DWLSIT_ADDR,
		        X.ITIV_RESULT_CD,
		        X.ED_DSPS_NM 				--종결 처분 코드
		 FROM
		     (
			SELECT A.*,			 
			COUNT(*) OVER() AS TOT_CNT,
			<isNotEmpty property="dataField">
				<isNotEmpty property="sortType">
					ROW_NUMBER() OVER(ORDER BY A.$dataField$ $sortType$ NULLS LAST) RN
				</isNotEmpty>
			</isNotEmpty>
			<isEmpty property="dataField">		
				ROW_NUMBER() OVER(ORDER BY A.ITIV_NO, A.RC_NO) RN
			</isEmpty>
			FROM
			(
				SELECT
				RT.RC_NO,
				RT.ITIV_NO,
				RT.CASE_NO,
				MAX(RIO.OUTSET_RESN) AS OUTSET_RESN,
                MAX(RIR.ITIV_RESULT_CD) AS ITIV_RESULT_CD,
                MAX(RIR.ITIV_CN) AS ITIV_CN,
                MAX(RTT.TRGTER_NM) KEEP(DENSE_RANK FIRST ORDER BY RTT.TRGTER_SN ASC) || (CASE WHEN COUNT(DISTINCT(RTT.TRGTER_SN)) > 1 THEN ' 외 '||(COUNT(DISTINCT(RTT.TRGTER_SN))-1) END) AS TRGTER_NM,
                MAX(DGUARD.DECRYPT('TBL','ENC',RTT.TRGTER_RRN)) KEEP(DENSE_RANK FIRST ORDER BY RTT.TRGTER_SN ASC) AS TRGTER_RRN,
                MAX(RTT.DWLSIT_ADDR) KEEP(DENSE_RANK FIRST ORDER BY RTT.TRGTER_SN ASC) AS DWLSIT_ADDR,
                TO_CHAR(MAX(RT.RC_DT), 'YYYY-MM-DD') AS RC_DT,
				TO_CHAR(MAX(RIO.OUTSET_DT), 'YYYY-MM-DD') AS ITIV_DT,
				FN_CD_NM(MAX(RIR.ITIV_RESULT_CD)) AS ITIV_RESULT_NM,
				TO_CHAR(MAX(RIR.WRITNG_DT), 'YYYY-MM-DD') AS RESULT_DT,
				FN_USER_NM(MAX(RT.CHARGER_ID)) AS CHARGER_NM,
				FN_DEPT_NM(MAX(RT.CHARGER_DEPT_CD)) AS CHARGER_DEPT_NM,
				FN_CD_NM(MAX(RIR.ED_DSPS_CD)) AS ED_DSPS_NM 			--종결 처분 코드
				FROM RC_TMPR RT
                INNER JOIN RC_TMPR_TRGTER RTT ON RT.RC_NO = RTT.RC_NO
                	AND RTT.TRGTER_SE_CD IN ( SELECT CC.ESNTL_CD FROM CMN_CD CC WHERE CC.UPPER_CD = '00102'  AND CC.CD_DC = 'suspct-Group' ) /*피의자 그룹*/
				LEFT JOIN RC_ITIV_OUTSET RIO ON RT.RC_NO = RIO.RC_NO
				LEFT JOIN RC_ITIV_RESULT RIR ON RT.ITIV_NO = RIR.ITIV_NO
				WHERE RT.USE_YN = 'Y'
				  AND RT.ITIV_NO IS NOT NULL
				<isNotEmpty property="searchTrgterNm" >
					AND RT.RC_NO IN (
						SELECT TT.RC_NO
						FROM RC_TMPR_TRGTER TT
						WHERE TT.TRGTER_NM = #searchTrgterNm#
						<isNotEmpty property="searchTrgterCl" prepend="AND">
							TT.TRGTER_SE_CD = #searchTrgterCl#
						</isNotEmpty>
					)
				</isNotEmpty>
				<isNotEmpty property="searchChager" >
					AND RT.CHARGER_ID = #searchChager#
				</isNotEmpty>
				<isNotEmpty property="searchDeptCd" >
					AND RT.CHARGER_DEPT_CD IN (
						SELECT DC.DEPT_CD
						FROM CMN_DEPT_CD DC
						WHERE DC.USE_YN = 'Y' AND DC.DEPT_CD != '00000'
						START WITH DC.DEPT_CD = #searchDeptCd#
						CONNECT BY PRIOR DC.DEPT_CD = DC.DEPT_UPPER_CD
					)
				</isNotEmpty>
				<isNotEmpty property="searchRcNoStart" >
					AND RT.RC_NO <![CDATA[ >= ]]> #searchRcNoStart#
				</isNotEmpty>
				<isNotEmpty property="searchRcNoEnd" >
					AND RT.RC_NO <![CDATA[ <= ]]> #searchRcNoEnd#
				</isNotEmpty>
				<isNotEmpty property="searchCaseNoStart" >
					AND RT.CASE_NO <![CDATA[ >= ]]> #searchCaseNoStart#
				</isNotEmpty>
				<isNotEmpty property="searchCaseNoEnd" >
					AND RT.CASE_NO <![CDATA[ <= ]]> #searchCaseNoEnd#
				</isNotEmpty>

				<isNotEmpty property="searchPrsctDeStart" >
						AND RT.WRITNG_DT <![CDATA[ >= ]]> TO_DATE(REPLACE(#searchPrsctDeStart#,'-',''),'YYYYMMDD')
				</isNotEmpty>
				<isNotEmpty property="searchPrsctDeEnd" >
					AND RT.WRITNG_DT <![CDATA[ <= ]]> TO_DATE(REPLACE(#searchPrsctDeEnd#,'-',''),'YYYYMMDD') + 0.999999
				</isNotEmpty>
				GROUP BY RT.RC_NO, RT.ITIV_NO, RT.CASE_NO, RIR.ED_DSPS_NM
			) A
		) X
		<isNotEmpty property="startRow" >
			WHERE (RN <![CDATA[ > ]]> #startRow# AND RN <![CDATA[ <= ]]> #endRow#)
		</isNotEmpty>
		ORDER BY RN ASC
	</select>



	<select id="selectCaseSttusSum" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT NVL(SUM(CASE WHEN A.PROGRS_STTUS_CD = '02103' THEN 1
			 			    WHEN A.PROGRS_STTUS_CD = '02131' THEN 1
	            			WHEN A.PROGRS_STTUS_CD = '02132' THEN 1
	            			WHEN A.PROGRS_STTUS_CD = '02141' THEN 1
	            			WHEN A.PROGRS_STTUS_CD = '02143' THEN 1	ELSE 0 END),0) AS ST_CNT1	--수사중
			 , NVL(SUM(CASE WHEN A.PROGRS_STTUS_CD = '02121' THEN 1 ELSE 0 END),0) AS ST_CNT2	--수사지휘건의
		  	 , NVL(SUM(CASE WHEN A.PROGRS_STTUS_CD = '02122' THEN 1 ELSE 0 END),0) AS ST_CNT3	--송치준비중
			 , NVL(SUM(CASE WHEN A.PROGRS_STTUS_CD = '02123' THEN 1 ELSE 0 END),0) AS ST_CNT4	--송치완료
		  FROM RC_TMPR A
		 WHERE A.USE_YN = 'Y'
		   AND A.CHARGER_DEPT_CD = #dept_cd#
		   AND A.CHARGER_ID = #esntl_id#
	</select>

	<select id="selectRcCaseSttusSum" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		SELECT NVL(SUM(CASE WHEN A.PROGRS_STTUS_CD = '02101' THEN 1
					  	    WHEN A.PROGRS_STTUS_CD = '02102' THEN 1
	            			WHEN A.PROGRS_STTUS_CD = '02104' THEN 1 ELSE 0 END),0) AS ST_CNT0	--사겁접수
		  FROM RC_TMPR A
		 WHERE A.USE_YN = 'Y'
		   AND A.WRITNG_DEPT_CD = #dept_cd#
		   AND A.WRITNG_ID = #esntl_id#
	</select>
	
	<update id="updateCrimeCaseSuspct" parameterClass="java.util.HashMap">
	<![CDATA[
		UPDATE TRN_SUSPCT
		   SET PRSEC_DSPS_DE = #PRSEC_DSPS_DE#
		     , PRSEC_DSPS_OUTLINE = #PRSEC_DSPS_OUTLINE#
		     , JUDMN_DE = #JUDMN_DE#
		     , JUDMN_OUTLINE = #JUDMN_OUTLINE#
		     , RM = #RM#
		     , UPDT_ID = #UPDT_ID#
		     , UPDT_DT = SYSDATE
		 WHERE TRN_NO = #TRN_NO#
		   AND RC_NO  = #RC_NO#
		   AND TRGTER_SN = #TRGTER_SN#
	]]>
	</update>

</sqlMap>